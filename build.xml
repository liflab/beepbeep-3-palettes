<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
	A build script for a super-project containing multiple sub-projects
    Copyright (C) 2019-2020  Sylvain Hallé

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<project name="SuperProject" default="all" basedir=".">

  <!-- The project's display name -->
  <property name="build.name" value="BeepBeep 3 Palettes"/>
  
  <!-- The author -->
  <property name="build.author" value="Sylvain Hallé"/>

  <!--Library folder. Used to store Ant Contrib -->
  <property name="build.rootlibdir" value="lib"/>

  <!--Javadoc folder. Used to place the files generated by the javadoc task -->
  <property name="build.rootdocdir" value="docs/javadoc"/>
  
  <!-- Check if ant-contrib is present -->
  <available file="${build.rootlibdir}/ant-contrib-1.0b3.jar" property="antcontrib.present"/>
  
  <!-- Load ant-contrib -->
  <target name="init" depends="ant-contrib">
    <taskdef resource="net/sf/antcontrib/antlib.xml"
        classpath="${build.rootlibdir}/ant-contrib-1.0b3.jar"/>
  </target>
  
  <!-- Download ant-contrib -->
  <target name="ant-contrib" unless="antcontrib.present"
    description="Install ant-contrib if not present">
    <echo message="ant-contrib is not installed. Downloading..." level="info"/>
    <mkdir dir="${build.rootlibdir}"/>
    <get src="http://sylvainhalle.github.io/AntRun/dependencies/ant-contrib-1.0b3-bin.zip" 
      dest="${build.rootlibdir}/ant-contrib-1.0b3-bin.zip"/>
    <unzip src="${build.rootlibdir}/ant-contrib-1.0b3-bin.zip" dest="${build.rootlibdir}">
      <patternset>
        <include name="**/*.jar"/>
      </patternset>
      <mapper type="flatten"/>
    </unzip>
  </target>
  
  <!-- Create paths -->
  <mkdir dir="${build.rootlibdir}"/>
  <mkdir dir="jars"/>

  <!-- Calls the "jar" task in each subfolder -->  
  <target name="jar" depends="init,prepare">
    <for param="subdir">
      <dirset dir=".">
        <include name="*"/>
      </dirset>
      <sequential>
          <if>
            <available file="@{subdir}/build.xml"/>
            <then>
              <trycatch>
                <try>
                  <ant dir="@{subdir}" target="jar" />
                </try>
                <catch>
                  <echo message="Build failed for folder @{subdir}"/>
                  <property name="build.onefailed" value="true"/>
                </catch>
              </trycatch>
            </then>
          </if>
      </sequential>
    </for>
    <fail message="Build failed for one of the palettes" if="build.onefailed"/>
  </target>
  
  <!-- Calls the "show-properties" task in each subfolder -->
  <target name="show-properties" depends="init">
    <for param="subdir">
      <dirset dir=".">
        <include name="*"/>
      </dirset>
      <sequential>
        <if>
          <available file="@{subdir}/build.xml"/>
          <then>
            <ant dir="@{subdir}" target="show-properties" />
          </then>
        </if>
      </sequential>
    </for>
  </target>

  <!-- Calls the "download-deps" task in each subfolder -->
  <target name="download-deps" depends="init">
    <for param="subdir">
      <dirset dir=".">
        <include name="*"/>
      </dirset>
      <sequential>
        <if>
          <available file="@{subdir}/build.xml"/>
          <then>
            <sequential>
              <echo message="Entering @{subdir}" />
              <ant dir="@{subdir}" target="download-deps" />
            </sequential>
          </then>
        </if>
      </sequential>
    </for>
  </target>
  
  <!-- Calls the "test" task in each subfolder -->
  <target name="test" depends="init">
    <for param="subdir">
      <dirset dir=".">
        <include name="*"/>
      </dirset>
      <sequential>
        <if>
          <available file="@{subdir}/build.xml"/>
          <then>
            <sequential>
              <echo message="Entering @{subdir}" />
              <trycatch>
                <try>
                  <ant dir="@{subdir}" target="test" />
                </try>
                <catch>
                  <echo message="Tests failed for folder @{subdir}"/>
                  <property name="test.onefailed" value="true"/>
                </catch>
              </trycatch>
            </sequential>
          </then>
        </if>
      </sequential>
    </for>
    <fail message="Tests failed for one of the palettes" if="test.onefailed"/>
  </target>
  
  <!-- Calls the "clean" task in each subfolder -->
  <target name="clean" depends="init">
    <for param="subdir">
      <dirset dir=".">
        <include name="*"/>
      </dirset>
      <sequential>
        <if>
          <available file="@{subdir}/build.xml"/>
          <then>
            <sequential>
              <echo message="Entering @{subdir}" />
              <ant dir="@{subdir}" target="clean" />
            </sequential>
          </then>
        </if>
      </sequential>
    </for>
    <echo message="Deleting jars dir" />
    <delete dir="jars" includes="*.jar" />
  </target>
  
  <!-- Calls the "wipe" task in each subfolder -->
  <target name="wipe" depends="init">
    <for param="subdir">
      <dirset dir=".">
        <include name="*"/>
      </dirset>
      <sequential>
        <if>
          <available file="@{subdir}/build.xml"/>
          <then>
            <sequential>
              <echo message="Entering @{subdir}" />
              <ant dir="@{subdir}" target="wipe" />
            </sequential>
          </then>
        </if>
      </sequential>
    </for>
  </target>

  <!-- Calls the jar task for each project -->
  <target name="all" depends="init,jar">
  </target>

  <!-- Prints the name of each subfolder that has a build script -->
  <target name="print-folders" depends="init">
    <for param="subdir">
      <dirset dir=".">
        <include name="*"/>
     </dirset>
     <sequential>
        <if>
          <available file="@{subdir}/build.xml"/>
          <then>
            <echo message="@{subdir}"/>
          </then>
        </if>
     </sequential>
    </for>
  </target>
    
  <!-- Builds the javadoc for the palettes -->
  <target name="javadoc" depends="init">
    <mkdir dir="${build.rootdocdir}"/>
    <mkdir dir="${build.rootdocdir}/doc-files"/>
    <javadoc
      destdir="docs/javadoc"
      packagenames="*"
      excludepackagenames=""
      defaultexcludes="yes"
      author="true"
      version="true"
      use="true"
      Encoding="utf8"
      docencoding="utf8"
      charset="utf8"
      windowtitle="BeepBeep 3 Palettes API Reference">
      <doctitle><![CDATA[<h1>]]>${build.name}<![CDATA[ Documentation</h1>]]></doctitle>
      <bottom><![CDATA[<i>Copyright&nbsp;&#169; ]]>${build.author}<![CDATA[. All Rights Reserved.</i>]]></bottom>
      <link href="http://docs.oracle.com/javase/6/docs/api/"/>
      <sourcefiles>
      	<fileset dir="." defaultexcludes="yes">
      		<include name="**/*.java"/>
      		<exclude name="**/*Test.java"/>
      	</fileset>
      </sourcefiles>
      <classpath>
        <fileset file="${build.rootlibdir}/beepbeep-3.jar"/>
      </classpath>
    </javadoc>
  </target>
  
  <!-- Task that prepares the environment before the compilation.
       This is mostly a *hack* so that the Jdbc palette, which depends on
       Tuples, can compile by copying tuples.jar to its dep dir. -->
  <target name="prepare" depends="init">
    <copy file="jars/tuples.jar" tofile="Jdbc/lib/tuples.jar" failonerror="false"/>
  </target>
</project>